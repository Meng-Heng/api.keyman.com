name: CI

on: [pull_request]

jobs:

  build-test:
    runs-on: windows-latest
    env:
      api_keyman_com_mssql_pw: Password1!
      api_keyman_com_mssql_user: sa
      api_keyman_com_mssqlconninfo: sqlsrv:Server=(local)\KEYMANAPI; Database=
      api_keyman_com_mssql_create_databases: true
      api_keyman_com_mssqldb0: keyboards
      api_keyman_com_mssqldb1: keyboards_1
      api_keyman_com_keyboard_info_zip: https://downloads.keyman.com/data/keyboard_info.zip
      api_keyman_com_model_info_zip: https://downloads.keyman.com/data/model_info.zip

    steps:
    - uses: actions/checkout@v2
    - name: Download and install SQL Server Express
      shell: cmd
      run: |
        choco install sql-server-2019 --no-progress --params "'/INSTANCEID=KEYMANAPI /INSTANCENAME=KEYMANAPI /SAPWD=Password1! /SECURITYMODE=SQL /UPDATEENABLED=FALSE /FEATURES=SQLENGINE,FULLTEXT'"
        rem Can't use localdb because it doesn't support FullText
        rem "C:\Program Files\Microsoft SQL Server\130\Tools\Binn\SqlLocalDB.exe" create keymanapi
        rem "C:\Program Files\Microsoft SQL Server\130\Tools\Binn\SqlLocalDB.exe" start keymanapi
        rem "C:\Program Files\Microsoft SQL Server\130\Tools\Binn\SqlLocalDB.exe" start
    - name:  Install dependencies
      shell: cmd
      run:   composer install --no-progress
    - name:  Install PHP SQL Server PDO Driver
      shell: powershell
      run: |
        Invoke-WebRequest -outfile pdo.zip https://github.com/microsoft/msphpsql/releases/download/v5.8.0/Windows-7.4.zip
        Expand-Archive pdo.zip -DestinationPath pdo\
        copy pdo\Windows-7.4\x64\php_pdo_sqlsrv_74_nts.dll c:\tools\php\ext\
        Add-Content -path c:\tools\php\php.ini -value '','extension=php_pdo_sqlsrv_74_nts.dll','mssql.secure_connection=Off','extension=php_intl.dll'
    - name:  Run unit tests
      shell: cmd
      run:   vendor\bin\phpunit tests
