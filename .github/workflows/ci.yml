name: CI

on: [pull_request]

jobs:

  build-test:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install keymanapi Database
      shell: cmd
      run: |
        "C:\Program Files\Microsoft SQL Server\130\Tools\Binn\SqlLocalDB.exe" create keymanapi
        "C:\Program Files\Microsoft SQL Server\130\Tools\Binn\SqlLocalDB.exe" start keymanapi
    - name: Install dependencies
      shell: cmd
      run: |
        composer install
    - name: Build keymanapi database
      shell: cmd
      run: |
        echo $mssqlconninfo="sqlsrv:Server=(localdb)\keymanapi;Integrated Security=true;Database="; > tools\db\localenv.php
        echo $mssqlconninfo_master="sqlsrv:Server=(localdb)\keymanapi;Integrated Security=true;Database=master"; >> tools\db\localenv.php
        echo $mssqldb0 = 'keyboards'; >> tools\db\localenv.php
        echo $mssqldb1 = 'keyboards_1'; >> tools\db\localenv.php
        php tools\db\build\build_cli.php
    - name: Run unit tests
      shell: cmd
      run: |
        vendor\bin\phpunit tests
